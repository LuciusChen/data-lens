#+TITLE: clutch — Interactive Database Client for Emacs
#+AUTHOR: Lucius Chen

* Overview

A pure Emacs Lisp database client with an interactive data browsing UI.
Supports MySQL (primary, daily-use) and PostgreSQL (compatible, less frequently tested).

- =mysql.el= — pure Elisp MySQL wire protocol implementation (no external CLI needed)
- =pg.el= — pure Elisp PostgreSQL wire protocol v3 implementation
- =clutch-db.el= — generic database interface (=cl-defgeneric= dispatch)
- =clutch-db-mysql.el= — MySQL backend adapter
- =clutch-db-pg.el= — PostgreSQL backend adapter
- =clutch.el= — interactive UI layer: column-paged result browser, record view, FK navigation, editing, transient menus, REPL
- =ob-mysql.el= — Org-Babel integration

*Note:* MySQL is the primary backend — thoroughly tested and used daily.
PostgreSQL support is functional and compatible, but has not been tested as extensively in daily use.

* Features

** Protocol Layer (mysql.el)

- Pure Elisp — no external dependencies
- MySQL wire protocol (HandshakeV10 + HandshakeResponse41)
- =mysql_native_password= and =caching_sha2_password= authentication
- =COM_QUERY= (text protocol) for executing SQL
- Prepared statements (=COM_STMT_PREPARE= / =COM_STMT_EXECUTE= / =COM_STMT_CLOSE=) with binary protocol
- TLS/SSL support via Emacs built-in GnuTLS (STARTTLS upgrade)
- Extended type system: DATE, TIME, DATETIME, TIMESTAMP, BIT with structured parsing
- Convenience macros: =with-mysql-connection=, =with-mysql-transaction=
- Utilities: =mysql-ping=, =mysql-escape-identifier=, =mysql-escape-literal=, =mysql-connect/uri=
- Extensible type parsing via =mysql-type-parsers=
- Proper error signaling with structured error types

** Protocol Layer (pg.el)

- Pure Elisp — no =libpq= or external CLI needed
- PostgreSQL wire protocol v3
- SCRAM-SHA-256 (SASL) and MD5 authentication
- TLS/SSL support via Emacs built-in GnuTLS
- OID-based type parsing (int, float, numeric, bool, date/time, json/jsonb, bytea)
- Convenience macros: =with-pg-connection=, =with-pg-transaction=
- Utilities: =pg-ping=, =pg-escape-identifier=, =pg-escape-literal=
- Proper error signaling with structured error types

** Interactive UI (clutch.el)

- Column-paged result display (no horizontal scrolling)
- SQL pagination (=LIMIT/OFFSET=) with fixed header and status bar
  - =tab-line=: row count, page, elapsed time, SQL query (with =nerd-icons=, Unicode fallback)
  - =header-line=: column names with =│= borders and underlined labels
- Row numbers as a table column; sort/pin indicators via =nerd-icons= (with Unicode fallback)
- Right-aligned numeric columns
- Record buffer for single-row detail view
- Foreign key detection and navigation
- Inline cell editing with UPDATE generation
- Inline INSERT (=o=) and DELETE (=d=) rows with confirmation
- WHERE filtering (=W=), client-side fuzzy filter (=/=), SQL =ORDER BY= sorting (=s=)
- Pin/unpin columns, adjust column widths
- CSV/Org export, copy as INSERT
- Schema browser with expandable column details (=TAB= to expand/collapse)
- SQL completion (table/column names, keywords), query history
- Eldoc: hover over a table name shows database, column count, and table comment; hover over a column name shows =table.column=, type, nullability, PK/FK references, and column comment
- Dedicated query console per connection (=clutch-query-console=), with fast switching between open consoles (=clutch-switch-console=)
- REPL mode (comint-based)

* Requirements

- Emacs 28.1+
- MySQL 5.7+ / 8.x, or PostgreSQL 12+

* Installation

Clone this repository and add it to your =load-path=:

#+begin_src emacs-lisp
(add-to-list 'load-path "~/repos/clutch")
(require 'clutch)
#+end_src

* Protocol Layer Usage (mysql.el)

#+begin_src emacs-lisp
(require 'mysql)

;; Connect
(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"))

;; Query
(let ((result (mysql-query conn "SELECT * FROM users LIMIT 10")))
  (mysql-result-columns result)  ;; column metadata
  (mysql-result-rows result))    ;; list of rows (list of values)

;; DML
(let ((result (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")))
  (mysql-result-affected-rows result)  ;; => 1
  (mysql-result-last-insert-id result)) ;; => auto-increment id

;; Disconnect
(mysql-disconnect conn)
#+end_src

** TLS Connection

#+begin_src emacs-lisp
(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"
                           :tls t))
#+end_src

** URI Connection

#+begin_src emacs-lisp
(setq conn (mysql-connect/uri "mysql://root:secret@127.0.0.1:3306/mydb"))
#+end_src

** Convenience Macros

#+begin_src emacs-lisp
;; Auto-close connection
(with-mysql-connection conn (:host "127.0.0.1" :user "root"
                             :password "secret" :database "mydb")
  (mysql-query conn "SELECT 1"))

;; Transaction with auto-rollback on error
(with-mysql-transaction conn
  (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")
  (mysql-query conn "INSERT INTO users (name) VALUES ('bob')"))
#+end_src

** Prepared Statements

#+begin_src emacs-lisp
(let ((stmt (mysql-prepare conn "SELECT * FROM users WHERE id = ?")))
  (let ((result (mysql-execute stmt 42)))
    (mysql-result-rows result))
  (mysql-stmt-close stmt))
#+end_src

** Utilities

#+begin_src emacs-lisp
(mysql-ping conn)                          ;; => t
(mysql-escape-identifier "my`table")       ;; => "`my``table`"
(mysql-escape-literal "it's a \"test\"")   ;; => "'it\\'s a \\\"test\\\"'"
#+end_src

* Protocol Layer Usage (pg.el)

#+begin_src emacs-lisp
(require 'pg)

;; Connect
(setq conn (pg-connect :host "127.0.0.1"
                        :port 5432
                        :user "postgres"
                        :password "secret"
                        :database "mydb"))

;; Query
(let ((result (pg-query conn "SELECT * FROM users LIMIT 10")))
  (pg-result-columns result)  ;; column metadata
  (pg-result-rows result))    ;; list of rows (list of values)

;; DML
(let ((result (pg-query conn "INSERT INTO users (name) VALUES ('alice')")))
  (pg-result-affected-rows result))  ;; => 1

;; Disconnect
(pg-disconnect conn)
#+end_src

** TLS Connection

#+begin_src emacs-lisp
(setq conn (pg-connect :host "127.0.0.1"
                        :port 5432
                        :user "postgres"
                        :password "secret"
                        :database "mydb"
                        :tls t))
#+end_src

** Convenience Macros

#+begin_src emacs-lisp
;; Auto-close connection
(with-pg-connection conn (:host "127.0.0.1" :user "postgres"
                          :password "secret" :database "mydb")
  (pg-query conn "SELECT 1"))

;; Transaction with auto-rollback on error
(with-pg-transaction conn
  (pg-query conn "INSERT INTO users (name) VALUES ('alice')")
  (pg-query conn "INSERT INTO users (name) VALUES ('bob')"))
#+end_src

* Interactive Client

** Quick Start

*** 1. Configure connections

#+begin_src emacs-lisp
(add-to-list 'load-path "~/repos/clutch")
(require 'clutch)

(setq clutch-connection-alist
      '(("dev-mysql" . (:host "127.0.0.1" :port 3306
                         :user "root" :password "test"
                         :database "mydb"))
        ("dev-pg"    . (:backend pg
                         :host "127.0.0.1" :port 5432
                         :user "postgres" :password "test"
                         :database "mydb"))))
#+end_src

MySQL is the default backend. Add =:backend pg= for PostgreSQL connections.

*** 2. Open a SQL editing buffer

#+begin_src
M-x clutch-mode
#+end_src

*** 3. Connect to the database

#+begin_src
C-c C-e                   ;; Select a connection via completing-read
                          ;; Mode-line shows MySQL[root@127.0.0.1:3306/mydb]
#+end_src

*** 4. Write and execute SQL

#+begin_src sql
SELECT * FROM users LIMIT 10;
#+end_src

Place the cursor on a SQL statement and press =C-c C-c= to execute. Results appear in a split result buffer below.

** SQL Editing (clutch-mode) Key Bindings

| Key         | Action                     |
|-------------+----------------------------|
| =C-c C-c=   | Execute SQL at point       |
| =C-c C-r=   | Execute selected region    |
| =C-c C-b=   | Execute entire buffer      |
| =C-c C-e=   | Connect / reconnect        |
| =C-c C-t=   | List all tables            |
| =C-c C-d=   | DESCRIBE table at point    |
| =C-c C-l=   | Query history              |
| =C-c C-o=   | Transient menu             |
| =TAB=       | Complete table/column name |

** Result Browser (clutch-result-mode) Key Bindings

| Key            | Action                                        |
|----------------+-----------------------------------------------|
| =RET=          | Open record view                              |
| =n= / =p=     | Next page / previous page (SQL pagination)    |
| =M->= / =M-<= | Last page / first page                       |
| =#=            | Query total row count                         |
| =]=            | Next column page                              |
| =[=            | Previous column page                          |
| =+=            | Widen current column                          |
| =-=            | Narrow current column                         |
| =C-c p=        | Pin current column                            |
| =C-c P=        | Unpin column                                  |
| =W=            | WHERE filter (press again to clear)           |
| =/=            | Client-side fuzzy filter (empty to clear)     |
| =s=            | Sort by column (toggles ASC/DESC on repeat)   |
| =S=            | Sort descending                               |
| =c=            | Jump to column                                |
| =g=            | Re-execute query                              |
| =e=            | Edit cell value                               |
| =o=            | Insert new row                                |
| =d=            | Delete row(s) (supports marks)                |
| =m=            | Toggle mark on row                            |
| =u=            | Unmark row                                    |
| =C-c C-c=     | Commit edits (generates UPDATE)               |
| =y=            | Copy cell value                               |
| =w=            | Copy row(s) as INSERT (supports region)       |
| =Y=            | Copy row(s) as CSV (supports region)          |
| =E=            | Export (org / csv)                             |
| =F=            | Toggle fullscreen                             |
| =?=            | Transient menu                                |

** Record View (clutch-record-mode) Key Bindings

| Key         | Action                        |
|-------------+-------------------------------|
| =RET=       | Expand long field / follow FK |
| =n= / =p=  | Next row / previous row       |
| =C-c '=    | Edit field                    |
| =y=         | Copy field value              |
| =w=         | Copy row as INSERT            |
| =g=         | Refresh                       |
| =q=         | Quit                          |

** Typical Workflows

*** Query + Pagination + Filter + Sort

#+begin_src
1. Write SQL:  SELECT * FROM orders;
2. C-c C-c    Execute → results displayed with pagination (default 500 rows/page)
              → tab-line shows: Σ 500 of ? rows • 1 / 1 • ⏱ 42ms • select * from orders
3. n / p      Next page / previous page
4. #          Query total rows → tab-line shows "Σ 500 of 1234 rows"
5. W          Enter filter: status = 'pending'
              → Appends WHERE clause, re-queries from page 1
6. /          Client-side filter: type a pattern to narrow visible rows instantly
7. s          Sort by current column (SQL ORDER BY), re-queries from page 1
8. W          Enter empty string → clears filter, restores original query
#+end_src

*** Foreign Key Navigation

#+begin_src
1. SELECT * FROM orders;     → C-c C-c to execute
2. Move cursor to a value in the user_id column (FK columns are underlined)
3. RET → opens record view
4. Press RET on an FK field → automatically runs SELECT * FROM users WHERE id = <value>
#+end_src

*** Editing Data

#+begin_src
1. SELECT * FROM users;      → C-c C-c to execute
2. Move cursor to the cell to modify
3. e                          → opens edit buffer
4. Edit the value, C-c C-c to confirm (C-c C-k to cancel)
5. Edit multiple cells — modified cells are highlighted
6. C-c C-c                   → confirmation prompt showing the UPDATE statements
#+end_src

*** Insert / Delete Rows

#+begin_src
1. SELECT * FROM users;      → C-c C-c to execute
2. o                          → opens insert buffer with all column fields
3. Fill values, C-c C-c to commit INSERT (C-c C-k to cancel)
4. d                          → delete row at point (or marked rows with m)
5. Confirmation shows the DELETE SQL before executing
#+end_src

** REPL Mode

#+begin_src
M-x clutch-repl          ;; Open REPL buffer
C-c C-e                     ;; Connect to database
mysql> SELECT * FROM users;  ;; Type SQL, auto-executes on ;
                             ;; Multi-line input supported (continuation prompt ->)
                             ;; M-p / M-n to browse history
#+end_src

** Query Console

=clutch-query-console= opens a dedicated buffer =*clutch: NAME*= for a saved
connection, enables =clutch-mode=, and connects automatically.  Repeated calls
with the same name switch to the existing buffer rather than creating a new one.

=clutch-switch-console= lists all open console buffers via =completing-read= for
fast switching between active connections.

Suggested global bindings:

#+begin_src emacs-lisp
(global-set-key (kbd "C-c d") #'clutch-query-console)
(global-set-key (kbd "C-c D") #'clutch-switch-console)
#+end_src

** Schema Browser

#+begin_src
C-c C-t                     ;; List all tables
TAB                          ;; Expand/collapse table columns (type, PK, FK)
E / C                        ;; Expand all / Collapse all
RET                          ;; Show DDL for table at point
g                            ;; Refresh
#+end_src

** Transient Menus

Requires the =transient= package (built-in since Emacs 28.1).

Press =C-c C-o= in clutch-mode or =?= in the result buffer to open the menu.

** Org-Babel Integration

Execute SQL directly in org files. Configuration:

#+begin_src emacs-lisp
(require 'ob-mysql)
(with-eval-after-load 'org
  (add-to-list 'org-babel-load-languages '(mysql . t))
  (org-babel-do-load-languages
   'org-babel-load-languages org-babel-load-languages))
#+end_src

Using a saved connection:

: #+begin_src mysql :connection dev
: SELECT * FROM users LIMIT 5;
: #+end_src

Or with inline connection parameters:

: #+begin_src mysql :host 127.0.0.1 :port 3306 :user root :password test :database mydb
: SHOW TABLES;
: #+end_src

=C-c C-c= executes the source block; results are inserted as an org table.

* Testing

** MySQL tests (require a running MySQL)

Start a MySQL instance:

#+begin_src sh
docker run --rm -e MYSQL_ROOT_PASSWORD=testpass -e MYSQL_USER=testuser \
  -e MYSQL_PASSWORD=testpass -e MYSQL_DATABASE=testdb -p 3307:3306 mysql:8
#+end_src

Load test data and run tests:

#+begin_src sh
mysql -h 127.0.0.1 -P 3307 -u testuser -ptestpass testdb < test-wide-table.sql
emacs --batch -L . -l test/test-run.el
#+end_src

** PostgreSQL tests (require a running PostgreSQL)

Start a PostgreSQL instance:

#+begin_src sh
docker run --rm -e POSTGRES_USER=testuser -e POSTGRES_PASSWORD=testpass \
  -e POSTGRES_DB=testdb -p 5433:5432 postgres:16-alpine
#+end_src

Run tests:

#+begin_src sh
emacs --batch -L . -l test/pg-test.el
#+end_src

Unit tests (message encoding, type parsing, auth) run without a server.
Live tests require the Docker instance above.

* License

GPL-3.0-or-later. See [[file:LICENSE][LICENSE]].
