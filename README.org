#+TITLE: data-lens — Interactive Database Client for Emacs
#+AUTHOR: Lucius Chen

* Overview

A pure Emacs Lisp MySQL client with an interactive data browsing UI.

- =mysql.el= — pure Elisp MySQL wire protocol implementation (no external CLI needed)
- =data-lens.el= — interactive UI layer: column-paged result browser, record view, FK navigation, editing, REPL
- =data-lens-transient.el= — Magit-style transient menus
- =ob-mysql.el= — Org-Babel integration

Inspired by [[https://github.com/cbbrowne/pg.el][pg.el]] which proved that implementing a database wire protocol
in pure Elisp is entirely feasible.

* Features

** Protocol Layer (mysql.el)

- Pure Elisp — no external dependencies
- MySQL wire protocol (HandshakeV10 + HandshakeResponse41)
- =mysql_native_password= and =caching_sha2_password= authentication
- =COM_QUERY= (text protocol) for executing SQL
- Prepared statements (=COM_STMT_PREPARE= / =COM_STMT_EXECUTE= / =COM_STMT_CLOSE=) with binary protocol
- TLS/SSL support via Emacs built-in GnuTLS (STARTTLS upgrade)
- Extended type system: DATE, TIME, DATETIME, TIMESTAMP, BIT with structured parsing
- Convenience macros: =with-mysql-connection=, =with-mysql-transaction=
- Utilities: =mysql-ping=, =mysql-escape-identifier=, =mysql-escape-literal=, =mysql-connect/uri=
- Extensible type parsing via =mysql-type-parsers=
- Proper error signaling with structured error types

** Interactive UI (data-lens.el)

- Column-paged result display (no horizontal scrolling)
- Record buffer for single-row detail view
- Foreign key detection and navigation
- Inline cell editing with UPDATE generation
- WHERE filtering and column sorting
- Pin/unpin columns, adjust column widths
- CSV/Org export, copy as INSERT
- Schema browser, SQL completion, query history
- REPL mode (comint-based)

* Requirements

- Emacs 28.1+
- A MySQL 5.7+ or 8.x server

* Installation

Clone this repository and add it to your =load-path=:

#+begin_src emacs-lisp
(add-to-list 'load-path "~/repos/data-lens")
(require 'data-lens)
#+end_src

* Protocol Layer Usage

#+begin_src emacs-lisp
(require 'mysql)

;; Connect
(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"))

;; Query
(let ((result (mysql-query conn "SELECT * FROM users LIMIT 10")))
  (mysql-result-columns result)  ;; column metadata
  (mysql-result-rows result))    ;; list of rows (list of values)

;; DML
(let ((result (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")))
  (mysql-result-affected-rows result)  ;; => 1
  (mysql-result-last-insert-id result)) ;; => auto-increment id

;; Disconnect
(mysql-disconnect conn)
#+end_src

** TLS Connection

#+begin_src emacs-lisp
(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"
                           :tls t))
#+end_src

** URI Connection

#+begin_src emacs-lisp
(setq conn (mysql-connect/uri "mysql://root:secret@127.0.0.1:3306/mydb"))
#+end_src

** Convenience Macros

#+begin_src emacs-lisp
;; Auto-close connection
(with-mysql-connection conn (:host "127.0.0.1" :user "root"
                             :password "secret" :database "mydb")
  (mysql-query conn "SELECT 1"))

;; Transaction with auto-rollback on error
(with-mysql-transaction conn
  (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")
  (mysql-query conn "INSERT INTO users (name) VALUES ('bob')"))
#+end_src

** Prepared Statements

#+begin_src emacs-lisp
(let ((stmt (mysql-prepare conn "SELECT * FROM users WHERE id = ?")))
  (let ((result (mysql-execute stmt 42)))
    (mysql-result-rows result))
  (mysql-stmt-close stmt))
#+end_src

** Utilities

#+begin_src emacs-lisp
(mysql-ping conn)                          ;; => t
(mysql-escape-identifier "my`table")       ;; => "`my``table`"
(mysql-escape-literal "it's a \"test\"")   ;; => "'it\\'s a \\\"test\\\"'"
#+end_src

* Interactive Client

** 快速开始

*** 1. 配置连接

#+begin_src emacs-lisp
(add-to-list 'load-path "~/repos/data-lens")
(require 'data-lens)

(setq data-lens-connection-alist
      '(("dev" . (:host "127.0.0.1" :port 3306
                  :user "root" :password "test"
                  :database "mydb"))))
#+end_src

*** 2. 打开 SQL 编辑 buffer

#+begin_src
M-x data-lens-mode        ;; 新建一个 SQL 编辑 buffer
#+end_src

*** 3. 连接数据库

#+begin_src
C-c C-e                   ;; 弹出 completing-read 选择连接
                          ;; mode-line 显示 MySQL[root@127.0.0.1:3306/mydb]
#+end_src

*** 4. 写 SQL 并执行

#+begin_src sql
SELECT * FROM users LIMIT 10;
#+end_src

光标放在 SQL 语句上，按 =C-c C-c= 执行。结果显示在底部分屏的 result buffer 中。

** SQL 编辑 (data-lens-mode) 快捷键

| 键位        | 功能             |
|-------------+------------------|
| =C-c C-c=   | 执行光标处的 SQL |
| =C-c C-r=   | 执行选中区域     |
| =C-c C-b=   | 执行整个 buffer  |
| =C-c C-e=   | 连接 / 重连      |
| =C-c C-t=   | 列出所有表       |
| =C-c C-d=   | DESCRIBE 光标处表名 |
| =C-c C-l=   | 查询历史         |
| =C-c C-o=   | Transient 菜单   |
| =TAB=       | 补全表名/列名    |

** 结果浏览 (data-lens-result-mode) 快捷键

| 键位        | 功能                             |
|-------------+----------------------------------|
| =RET=       | 打开 Record 视图                 |
| =]=         | 下一列页                         |
| =[=         | 上一列页                         |
| =+=         | 加宽当前列                       |
| =-=         | 缩窄当前列                       |
| =p=         | 固定当前列                       |
| =P=         | 取消固定                         |
| =W=         | WHERE 过滤（再按清除）           |
| =s= / =S=  | 按列排序 ASC / DESC              |
| =c=         | 跳转到某列                       |
| =n=         | 加载更多行                       |
| =g=         | 重新执行查询                     |
| =e=         | 编辑 cell 值                     |
| =C-c C-c=  | 提交编辑（生成 UPDATE）          |
| =y=         | 复制 cell 值                     |
| =w=         | 复制行为 INSERT 语句（支持选区） |
| =Y=         | 复制行为 CSV（支持选区）         |
| =E=         | 导出（org / csv）                |
| =?=         | Transient 菜单                   |

** Record 视图 (data-lens-record-mode) 快捷键

| 键位        | 功能                             |
|-------------+----------------------------------|
| =RET=       | 展开长字段 / 跟随外键           |
| =n= / =p=  | 下一行 / 上一行                  |
| =C-c '=    | 编辑字段                         |
| =y=         | 复制字段值                       |
| =w=         | 复制行为 INSERT                  |
| =g=         | 刷新                             |
| =q=         | 关闭                             |

** 典型工作流示例

*** 查询 + 过滤 + 排序

#+begin_src
1. 写 SQL:  SELECT * FROM orders;
2. C-c C-c  执行 → 结果显示在底部
3. W        输入过滤条件: status = 'pending'
            → 自动追加 WHERE status = 'pending' 重新查询
4. s        选择列排序 (默认当前列)
5. W        输入空字符串 → 清除过滤，恢复原始查询
#+end_src

*** 外键导航

#+begin_src
1. SELECT * FROM orders;     → C-c C-c 执行
2. 光标移到 user_id 列的某个值上（外键列会有下划线高亮）
3. RET → 打开 Record 视图
4. 在 FK 字段上按 RET → 自动执行 SELECT * FROM users WHERE id = <value>
#+end_src

*** 编辑数据

#+begin_src
1. SELECT * FROM users;      → C-c C-c 执行
2. 光标移到要修改的 cell
3. e                          → 打开编辑 buffer
4. 修改内容，C-c C-c 确认   （C-c C-k 取消）
5. 可以编辑多个 cell，修改过的 cell 会高亮显示
6. C-c C-c                   → 弹出确认，显示将执行的 UPDATE 语句
#+end_src

** REPL 模式

#+begin_src
M-x data-lens-repl          ;; 打开 REPL buffer
C-c C-e                     ;; 连接数据库
mysql> SELECT * FROM users;  ;; 输入 SQL，以 ; 结尾后自动执行
                             ;; 支持多行输入（续行提示 ->）
                             ;; M-p / M-n 浏览历史
#+end_src

** Schema 浏览

#+begin_src
C-c C-t                     ;; 列出所有表
RET                          ;; 在表名上按回车 → 查看表结构 (DESCRIBE)
g                            ;; 刷新
#+end_src

** Transient 菜单

需要安装 =transient= 包（Magit 自带）。

#+begin_src emacs-lisp
(require 'data-lens-transient)
#+end_src

在 data-lens-mode 中按 =C-c C-o= 或在 result buffer 中按 =?= 打开菜单。

** Org-Babel 集成

在 org 文件中直接执行 SQL，需要配置：

#+begin_src emacs-lisp
(require 'ob-mysql)
(with-eval-after-load 'org
  (add-to-list 'org-babel-load-languages '(mysql . t))
  (org-babel-do-load-languages
   'org-babel-load-languages org-babel-load-languages))
#+end_src

使用已存连接：

: #+begin_src mysql :connection dev
: SELECT * FROM users LIMIT 5;
: #+end_src

或内联连接参数：

: #+begin_src mysql :host 127.0.0.1 :port 3306 :user root :password test :database mydb
: SHOW TABLES;
: #+end_src

=C-c C-c= 执行代码块，结果自动插入为 org 表格。

* Testing

** Integration tests (require a running MySQL)

Start a MySQL instance:

#+begin_src sh
docker run --rm -e MYSQL_ROOT_PASSWORD=testpass -e MYSQL_USER=testuser \
  -e MYSQL_PASSWORD=testpass -e MYSQL_DATABASE=testdb -p 3307:3306 mysql:8
#+end_src

Load test data and run tests:

#+begin_src sh
mysql -h 127.0.0.1 -P 3307 -u testuser -ptestpass testdb < test-wide-table.sql
emacs --batch -L . -l test-run.el
#+end_src

* License

GPL-3.0-or-later. See [[file:LICENSE][LICENSE]].
