#+TITLE: clutch — Interactive Database Client for Emacs
#+AUTHOR: Lucius Chen

* Overview

A pure Emacs Lisp database client with an interactive data browsing UI.
Supports MySQL (primary, daily-use), PostgreSQL, and SQLite (Emacs 29+).

- =mysql.el= — pure Elisp MySQL wire protocol implementation (no external CLI needed)
- =pg.el= — pure Elisp PostgreSQL wire protocol v3 implementation
- =clutch-db.el= — generic database interface (=cl-defgeneric= dispatch)
- =clutch-db-mysql.el= — MySQL backend adapter
- =clutch-db-pg.el= — PostgreSQL backend adapter
- =clutch-db-sqlite.el= — SQLite backend adapter (uses Emacs 29+ built-in sqlite)
- =clutch.el= — interactive UI layer: column-paged result browser, record view, FK navigation, editing, transient menus, REPL
- =ob-clutch.el= — Org-Babel integration (mysql/postgresql/sqlite)

#+CAPTION: Result browser with unified transient workflow (C-c ?), copy (c), full export (e), and column paging via [ and ].
[[file:assets/clutch-overview.png]]

*Note:* MySQL is the primary backend — thoroughly tested and used daily.
PostgreSQL support is functional and compatible, but has not been tested as extensively in daily use.
SQLite support requires Emacs 29+ (built-in =sqlite-*= functions); no external dependencies.

* Features

** Protocol Layer (mysql.el)

- Pure Elisp — no external dependencies
- MySQL wire protocol (HandshakeV10 + HandshakeResponse41)
- =mysql_native_password= and =caching_sha2_password= authentication
- =COM_QUERY= (text protocol) for executing SQL
- Prepared statements (=COM_STMT_PREPARE= / =COM_STMT_EXECUTE= / =COM_STMT_CLOSE=) with binary protocol
- TLS/SSL support via Emacs built-in GnuTLS (STARTTLS upgrade)
- Extended type system: DATE, TIME, DATETIME, TIMESTAMP, BIT with structured parsing
- Convenience macros: =with-mysql-connection=, =with-mysql-transaction=
- Utilities: =mysql-ping=, =mysql-escape-identifier=, =mysql-escape-literal=, =mysql-connect/uri=
- Extensible type parsing via =mysql-type-parsers=
- Proper error signaling with structured error types

** Protocol Layer (pg.el)

- Pure Elisp — no =libpq= or external CLI needed
- PostgreSQL wire protocol v3
- SCRAM-SHA-256 (SASL) and MD5 authentication
- TLS/SSL support via Emacs built-in GnuTLS
- OID-based type parsing (int, float, numeric, bool, date/time, json/jsonb, bytea)
- Convenience macros: =with-pg-connection=, =with-pg-transaction=
- Utilities: =pg-ping=, =pg-escape-identifier=, =pg-escape-literal=
- Proper error signaling with structured error types

** Interactive UI (clutch.el)

- Column-paged result display (no horizontal scrolling)
- SQL pagination (=LIMIT/OFFSET=) with fixed header and status bar
  - =tab-line=: row count, page, elapsed time, aggregate status, and active filters (with =nerd-icons=, Unicode fallback)
  - =header-line=: column names with =│= borders and underlined labels
- After execution, focus stays in the SQL buffer while results refresh below
- Last successfully executed SQL region is highlighted in the editor
- Row numbers as a table column; sort/pin indicators via =nerd-icons= (with Unicode fallback)
- Right-aligned numeric columns
- Record buffer for single-row detail view
- Foreign key detection and navigation
- Inline cell editing with UPDATE generation
- Inline INSERT (=o=) and DELETE (=d=) rows with confirmation
- WHERE filtering (=W=), client-side fuzzy filter (=/=), SQL =ORDER BY= sorting (=s=)
- Pin/unpin columns, adjust column widths
- CSV/Org export, copy as INSERT
- Schema browser with expandable column details (=TAB= to expand/collapse)
- SQL completion: table/column names scoped to the FROM clause of the current statement, plus keywords
- Eldoc: three-tier lookup — (1) schema-aware: table name shows database, column count, and table comment; column name shows =table.column=, type, nullability, PK/FK references, and comment; (2) live MySQL =HELP= lookup (MySQL only, result cached per session); (3) static reference covering ~150 SQL keywords and functions with call signatures and descriptions (works without a connection; MySQL/PG-specific entries annotated)
- Mode-line spinner (=…=) while a query is executing, so you always know when clutch is waiting for the server
- Dedicated query console per connection (=clutch-query-console=), with fast switching between open consoles (=clutch-switch-console=); console content persisted across Emacs sessions
- Auto-reconnect: if the connection drops, clutch silently reconnects before the next query using the stored credentials
- Value viewer (=v=): auto-detects JSON (pretty-printed with =json-ts-mode=), XML (formatted via =xmllint= if available, rendered with =nxml-mode=), or BLOB (concise text/hex preview); XML/BLOB size is shown in viewer header-line (without polluting content highlighting)
- REPL mode (comint-based)

* Requirements

- Emacs 28.1+ for MySQL and PostgreSQL backends
- Emacs 29.1+ for the SQLite backend (built-in =sqlite-*= functions)
- MySQL 5.7+ / 8.x, PostgreSQL 12+, or SQLite 3 (via Emacs built-in)

* Installation

Clone this repository and add it to your =load-path=
(skip this if installed via a package manager):

#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/clutch")
(require 'clutch)
#+end_src

* Interactive Client

** Quick Start

*** 1. Configure connections

#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/clutch")
(require 'clutch)

(setq clutch-connection-alist
      '(("dev-mysql"  . (:backend mysql
                          :host "127.0.0.1" :port 3306
                          :user "root" :password "test"
                          :database "mydb"))
        ("dev-pg"     . (:backend pg
                          :host "127.0.0.1" :port 5432
                          :user "postgres" :password "test"
                          :database "mydb"))
        ("dev-sqlite" . (:backend sqlite
                          :database "/path/to/my.db"))))
#+end_src

Each entry should specify =:backend= explicitly (=mysql=, =pg=, or =sqlite=).
Omitting =:backend= defaults to =mysql=, but explicit is clearer.
SQLite connections only require =:database= (the file path); no host, port, or user.
Use =":memory:"= for a transient in-memory database (data is lost when disconnected).
=:password= is optional for network backends — see [[*Password Management]] for auth-source integration.
For MySQL/PostgreSQL, =:read-timeout= (seconds) can be set per connection entry.
TLS can be enabled per entry with =:tls t=; see backend TLS sections above for
verification defaults and CA trustfile configuration.

*** 2. Open a query console

#+begin_src
M-x clutch-query-console   ;; Select a saved connection → opens *clutch: NAME*
                            ;; and connects automatically
                            ;; Mode-line: MySQL[root@127.0.0.1:3306/mydb]
                            ;;         or PostgreSQL[postgres@127.0.0.1:5432/mydb]
                            ;;         or SQLite[?@?:?//path/to/my.db]
#+end_src

Repeated calls with the same name switch to the existing buffer instead of
opening a new one.  Use =clutch-switch-console= to jump between open consoles.

*** 3. Write and execute SQL

#+begin_src sql
SELECT * FROM users LIMIT 10;
#+end_src

Press =C-c C-c= to execute.  If a region is selected, the selected SQL runs; otherwise the statement at point runs.  Results appear in a split result buffer below.

** Password Management

=:password= is optional in connection entries. When omitted (or nil), the
password is looked up via Emacs's built-in =auth-source= library, which supports:

- =~/.authinfo= / =~/.authinfo.gpg= (netrc format)
- =pass= (the Unix password manager), when =auth-source-pass= is enabled

*** ~/.authinfo example

#+begin_src
machine 127.0.0.1 login root password secret port 3306
#+end_src

Connection entry without hardcoded password:

#+begin_src emacs-lisp
("dev-mysql" . (:host "127.0.0.1" :port 3306 :user "root" :database "mydb"))
#+end_src

*** pass example — connection name as entry name (recommended)

When =auth-source-pass= is loaded, clutch automatically looks up a pass
entry whose path ends with the connection name.  The entry can live
anywhere in the pass store — subdirectories are fine:

#+begin_src emacs-lisp
(require 'auth-source-pass)

(setq clutch-connection-alist
      '(("dev-mysql" . (:backend mysql
                         :host "db.example.com" :port 3306
                         :user "alice" :database "mydb"))))
#+end_src

Store the password under any path that ends with the connection name:

#+begin_src sh
pass insert mysql/dev-mysql   ;; or just: pass insert dev-mysql
#+end_src

The pass store reveals only =mysql/dev-mysql= — no host or username.
Use =:pass-entry "other-name"= to override the suffix when the entry
name must differ from the connection name.

*** Fallback: standard auth-source lookup

If no pass entry matches the connection name, clutch falls back to
standard =auth-source-search= by =:host=, =:user=, and =:port=.  This
covers =~/.authinfo=, =~/.authinfo.gpg=, and pass entries named after
the host.  See the [[https://www.gnu.org/software/emacs/manual/html_node/auth/index.html][auth-source manual]] for details.

** Working with SQL files

You can also open any =.sql= file, enable =clutch-mode=, and connect
manually — the query console is not required.

#+begin_src
1. Open a .sql file
2. M-x clutch-mode        — enable clutch (inherits sql-mode syntax/fontification)
3. C-c C-e                 — select a saved connection or enter params manually
                             Mode-line shows MySQL[root@127.0.0.1:3306/mydb]
4. C-c C-c                 — execute query at point
#+end_src

To activate =clutch-mode= automatically for =.sql= files, add to your config:

#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.sql\\'" . clutch-mode))
#+end_src

=.mysql= files activate =clutch-mode= automatically without any configuration.

** SQL Editing (clutch-mode) Key Bindings

| Key         | Action                     |
|-------------+----------------------------|
| =C-c C-c=   | Execute region or query at point |
| =C-c C-r=   | Execute selected region          |
| =C-c C-b=   | Execute entire buffer      |
| =C-c C-e=   | Connect / reconnect        |
| =C-c C-t=   | List all tables            |
| =C-c C-j=   | Browse table data          |
| =C-c C-d=   | DESCRIBE table at point    |
| =C-c C-p=   | Preview SQL (dry-run)      |
| =C-c ?=     | Transient menu             |
| =TAB=       | Complete table/column name |

** Result Browser (clutch-result-mode) Key Bindings

| Key            | Action                                        |
|----------------+-----------------------------------------------|
| =RET=          | Open record view                              |
| =n= / =p=     | Next row / previous row (same column)         |
| =N= / =P=     | Next page / previous page (SQL pagination)    |
| =M->= / =M-<= | Last page / first page                       |
| =#=            | Query total row count                         |
| =A=            | Aggregate numeric values (region/current cell; =C-u= with region enters visual refine mode) |
| =]=            | Next column page                              |
| =[=            | Previous column page                          |
| ===            | Widen current column                          |
| =-=            | Narrow current column                         |
| =C-c p=        | Pin current column                            |
| =C-c P=        | Unpin column                                  |
| =W=            | WHERE filter (press again to clear)           |
| =/=            | Client-side fuzzy filter (empty to clear)     |
| =s=            | Sort by column (toggles ASC/DESC on repeat)   |
| =S=            | Sort descending                               |
| =C=            | Jump to column                                |
| =g=            | Re-execute query                              |
| =C-c '=       | Edit cell value                               |
| =i=            | Insert new row                                |
| =d=            | Delete row(s) (supports region)               |
| =C-c C-c=     | Commit edits (generates UPDATE)               |
| =C-c C-p=      | Preview SQL (query / pending update / selected delete) |
| =c=            | Copy... (tsv/csv/insert; region = selected block, no region = current cell; =C-u= with region enters visual refine mode) |
| =v=            | View cell value (JSON / XML / BLOB preview — auto-detected) |
| =e=            | Export all rows (copy / file)                     |
| =f=            | Toggle fullscreen                             |
| =C-c ?=        | Transient menu                                |

Tip: =c= supports both regular region and rectangular selection (=C-x SPC=).
Tip: use =A= after =C-x SPC= to aggregate selected numeric cells quickly.

*** Visual Refine Mode (=C-u c= / =C-u A=)

With an active region, =C-u c= or =C-u A= enters *refine mode*: the selected
rectangle is highlighted and you interactively exclude rows or columns before
the copy/aggregate is performed.  The tab-line at the top of the result buffer
is replaced with a colour-coded hint for the duration of the session.

#+begin_example
Step 1 — select a region, then press C-u c or C-u A.
         The rect is highlighted; tab-line shows available keys.

  REFINE  m row   x col   RET confirm   C-g cancel     ← tab-line

  id   name    email              joined
  ─────────────────────────────────────────────
  1  ░ Alice ░ alice@example.com ░ 2023-01-15  ┐
  2  ░ Bob   ░ bob@example.com   ░ 2023-03-22  ├─ rect (highlighted)
  3  ░ Carol ░ carol@example.com ░ 2024-07-01  ┘
  4    Dave    dave@example.com    2024-09-10     (outside rect)

Step 2 — press m on row 2 to exclude it (dim + strikethrough).

  1  ░ Alice ░ alice@example.com ░ 2023-01-15
  2    Bob     bob@example.com     2023-03-22   ← excluded
  3  ░ Carol ░ carol@example.com ░ 2024-07-01

Step 3 — press x on the email column to exclude it.

  1  ░ Alice ░ ~~email~~         ░ 2023-01-15
  3  ░ Carol ░ ~~email~~         ░ 2024-07-01

Step 4 — press RET to confirm.
         Result: rows {1, 3} × cols {id, name, joined}.
#+end_example

| Key   | Action                              |
|-------+-------------------------------------|
| =m=   | Toggle exclusion of row at point    |
| =x=   | Toggle exclusion of column at point |
| =RET= | Confirm — execute copy / aggregate  |
| =C-g= | Cancel — discard all exclusions     |

** Record View (clutch-record-mode) Key Bindings

| Key         | Action                        |
|-------------+-------------------------------|
| =RET=       | Expand long field / follow FK |
| =n= / =p=  | Next row / previous row       |
| =v=         | View field value (JSON / XML / BLOB preview) |
| =g=         | Refresh                       |
| =q=         | Quit                          |
| =C-c ?=     | Transient menu                |

** Typical Workflows

*** Query + Pagination + Filter + Sort

#+begin_src
1. Write SQL:  SELECT * FROM orders;
2. C-c C-c    Execute → results displayed with pagination (default 500 rows/page)
              → tab-line shows: Σ 500 of ? rows • 1 / 1 • ⏱ 42ms
3. N / P      Next page / previous page
4. #          Query total rows → tab-line shows "Σ 500 of 1234 rows"
5. ] / [      Move across column pages when result has many columns
              → pinned columns stay visible while column pages switch
6. W          Enter filter: status = 'pending'
              → Appends WHERE clause, re-queries from page 1
7. /          Client-side filter: type a pattern to narrow visible rows instantly
8. s          Sort by current column (SQL ORDER BY), re-queries from page 1
9. A          Aggregate selected cells/current cell
              → tab-line adds aggregate status (sum/avg/min/max + [rows/cells/skipped])
10. W         Enter empty string → clears filter, restores original query
#+end_src

*** Foreign Key Navigation

#+begin_src
1. SELECT * FROM orders;     → C-c C-c to execute
2. Move cursor to a value in the user_id column (FK columns are underlined)
3. RET → opens record view
4. Press RET on an FK field → automatically runs SELECT * FROM users WHERE id = <value>
#+end_src

*** Editing Data

#+begin_src
1. SELECT * FROM users;      → C-c C-c to execute
2. Move cursor to the cell to modify
3. C-c '                      → opens edit buffer
4. Edit the value, C-c C-c to stage (C-c C-k to cancel)
                               echo area shows "N pending edits — C-c C-c to commit"
5. Repeat for other cells — modified cells are highlighted
6. C-c C-c in result buffer  → confirmation prompt showing the UPDATE statements
#+end_src

*** Insert / Delete Rows

#+begin_src
1. SELECT * FROM users;      → C-c C-c to execute
2. i                          → opens insert buffer with all column fields
3. Fill values, C-c C-c to commit INSERT (C-c C-k to cancel)
4. Use normal Emacs region selection to select rows
5. d                          → delete current row or selected region
6. Confirmation shows the DELETE SQL before executing
#+end_src

** REPL Mode

#+begin_src
M-x clutch-repl          ;; Open REPL buffer (*clutch REPL*)
C-c C-e                     ;; Connect to database
db> SELECT * FROM users;     ;; Type SQL, auto-executes on ;
                             ;; Multi-line input supported (continuation prompt     ->)
#+end_src

** Query Console

=clutch-query-console= opens a dedicated buffer =*clutch: NAME*= for a saved
connection, enables =clutch-mode=, and connects automatically.  Repeated calls
with the same name switch to the existing buffer rather than creating a new one.

=clutch-switch-console= lists all open console buffers via =completing-read= for
fast switching between active connections.

*** Console persistence

Buffer content is automatically saved to =clutch-console-directory=
(default: =~/.emacs.d/clutch/=) and restored the next time the same
console is opened.  Each connection gets its own file (e.g. =dev-mysql.sql=).
Content is saved when the buffer is killed or when Emacs exits.

Suggested global bindings:

#+begin_src emacs-lisp
(global-set-key (kbd "C-c d") #'clutch-query-console)
(global-set-key (kbd "C-c D") #'clutch-switch-console)
#+end_src

** Schema Browser

#+begin_src
C-c C-t                     ;; List all tables
C-c C-j                     ;; Browse table data (select table, insert SELECT into console)
TAB                          ;; Expand/collapse table columns (type, PK, FK)
E / C                        ;; Expand all / Collapse all
RET                          ;; Show DDL for table at point
v                            ;; Browse table data at point (insert SELECT into console)
g                            ;; Refresh
#+end_src

** Transient Menus

Requires the =transient= package (built-in since Emacs 28.1).

Press =C-c ?= to open the transient menu.

** Org-Babel Integration

Execute SQL directly in org files. Configuration:

#+begin_src emacs-lisp
(require 'ob-clutch)
(with-eval-after-load 'org
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((mysql . t)
     (postgresql . t)
     (sqlite . t))))
#+end_src

Using a saved connection:

: #+begin_src mysql :connection dev
: SELECT * FROM users LIMIT 5;
: #+end_src

Or with inline connection parameters:

: #+begin_src mysql :host 127.0.0.1 :port 3306 :user root :password test :database mydb
: SHOW TABLES;
: #+end_src

PostgreSQL and SQLite blocks are also supported:

: #+begin_src postgresql :connection dev-pg
: SELECT now();
: #+end_src

: #+begin_src sqlite :database /tmp/demo.db
: SELECT name FROM sqlite_master WHERE type = 'table';
: #+end_src

Generic form with explicit backend:

: #+begin_src clutch :backend pg :host 127.0.0.1 :port 5432 :user postgres :password test :database mydb
: SELECT version();
: #+end_src

Compatibility entry files:
- =ob-mysql.el=, =ob-postgresql.el=, =ob-sqlite.el= are thin language entry points.
- Core execution logic lives in =ob-clutch.el=.

=C-c C-c= executes the source block; results are inserted as an org table.

** Query Timeout and Interrupt

- =clutch-query-timeout-seconds= controls query I/O idle timeout (default: 30s).
- MySQL/PostgreSQL connections can override timeout via connection plist key =:read-timeout=.
- During long-running queries, press =C-g= to interrupt.
  - clutch will drop the current connection to avoid protocol desync.
  - the next command auto-reconnects when saved connection params are available.
- High-risk DML (=UPDATE/DELETE= without top-level =WHERE=) requires typed
  confirmation (=YES=) before execution.

* Protocol Layer Usage (mysql.el)

#+begin_src emacs-lisp
(require 'mysql)

;; Connect
(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"))

;; Query
(let ((result (mysql-query conn "SELECT * FROM users LIMIT 10")))
  (mysql-result-columns result)  ;; column metadata
  (mysql-result-rows result))    ;; list of rows (list of values)

;; DML
(let ((result (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")))
  (mysql-result-affected-rows result)  ;; => 1
  (mysql-result-last-insert-id result)) ;; => auto-increment id

;; Disconnect
(mysql-disconnect conn)
#+end_src

** TLS Connection

When =:tls t= is used, certificate and hostname verification are enabled by
default (secure-by-default).  If verification fails, connection setup aborts
with an error; it does not silently downgrade to insecure mode.

To trust private/internal CAs, configure:

- =mysql-tls-trustfiles= (list of CA certificate files)
- =mysql-tls-verify-server= (defaults to =t=; set to =nil= only for local/dev)
- =mysql-tls-keylist= for client certificates when required

#+begin_src emacs-lisp
;; Example: custom CA for private PKI
(setq mysql-tls-trustfiles '("/etc/ssl/certs/internal-ca.pem"))

(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"
                           :tls t))
#+end_src

** URI Connection

#+begin_src emacs-lisp
(setq conn (mysql-connect/uri "mysql://root:secret@127.0.0.1:3306/mydb"))
#+end_src

** Convenience Macros

#+begin_src emacs-lisp
;; Auto-close connection
(with-mysql-connection conn (:host "127.0.0.1" :user "root"
                             :password "secret" :database "mydb")
  (mysql-query conn "SELECT 1"))

;; Transaction with auto-rollback on error
(with-mysql-transaction conn
  (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")
  (mysql-query conn "INSERT INTO users (name) VALUES ('bob')"))
#+end_src

** Prepared Statements

#+begin_src emacs-lisp
(let ((stmt (mysql-prepare conn "SELECT * FROM users WHERE id = ?")))
  (let ((result (mysql-execute stmt 42)))
    (mysql-result-rows result))
  (mysql-stmt-close stmt))
#+end_src

** Utilities

#+begin_src emacs-lisp
(mysql-ping conn)                          ;; => t
(mysql-escape-identifier "my`table")       ;; => "`my``table`"
(mysql-escape-literal "it's a \"test\"")   ;; => "'it\\'s a \\\"test\\\"'"
#+end_src

* Protocol Layer Usage (pg.el)

#+begin_src emacs-lisp
(require 'pg)

;; Connect
(setq conn (pg-connect :host "127.0.0.1"
                        :port 5432
                        :user "postgres"
                        :password "secret"
                        :database "mydb"))

;; Query
(let ((result (pg-query conn "SELECT * FROM users LIMIT 10")))
  (pg-result-columns result)  ;; column metadata
  (pg-result-rows result))    ;; list of rows (list of values)

;; DML
(let ((result (pg-query conn "INSERT INTO users (name) VALUES ('alice')")))
  (pg-result-affected-rows result))  ;; => 1

;; Disconnect
(pg-disconnect conn)
#+end_src

** TLS Connection

When =:tls t= is used, certificate and hostname verification are enabled by
default (secure-by-default).  If verification fails, connection setup aborts
with an error; it does not silently downgrade to insecure mode.

To trust private/internal CAs, configure:

- =pg-tls-trustfiles= (list of CA certificate files)
- =pg-tls-verify-server= (defaults to =t=; set to =nil= only for local/dev)
- =pg-tls-keylist= for client certificates when required

#+begin_src emacs-lisp
;; Example: custom CA for private PKI
(setq pg-tls-trustfiles '("/etc/ssl/certs/internal-ca.pem"))

(setq conn (pg-connect :host "127.0.0.1"
                        :port 5432
                        :user "postgres"
                        :password "secret"
                        :database "mydb"
                        :tls t))
#+end_src

** Convenience Macros

#+begin_src emacs-lisp
;; Auto-close connection
(with-pg-connection conn (:host "127.0.0.1" :user "postgres"
                          :password "secret" :database "mydb")
  (pg-query conn "SELECT 1"))

;; Transaction with auto-rollback on error
(with-pg-transaction conn
  (pg-query conn "INSERT INTO users (name) VALUES ('alice')")
  (pg-query conn "INSERT INTO users (name) VALUES ('bob')"))
#+end_src

* Testing

** MySQL tests (require a running MySQL)

Start a MySQL instance:

#+begin_src sh
docker run --rm -e MYSQL_ROOT_PASSWORD=testpass -e MYSQL_USER=testuser \
  -e MYSQL_PASSWORD=testpass -e MYSQL_DATABASE=testdb -p 3307:3306 mysql:8
#+end_src

Load test data and run tests:

#+begin_src sh
mysql -h 127.0.0.1 -P 3307 -u testuser -ptestpass testdb < test-wide-table.sql
emacs --batch -L . -l test/test-run.el
#+end_src

** PostgreSQL tests (require a running PostgreSQL)

Start a PostgreSQL instance:

#+begin_src sh
docker run --rm -e POSTGRES_USER=testuser -e POSTGRES_PASSWORD=testpass \
  -e POSTGRES_DB=testdb -p 5433:5432 postgres:16-alpine
#+end_src

Run tests:

#+begin_src sh
emacs --batch -L . -l test/pg-test.el
#+end_src

Unit tests (message encoding, type parsing, auth) run without a server.
Live tests require the Docker instance above.

* Roadmap

- SQL rewrite engine (AST-based) for safer, semantics-aware transformations
  across complex queries (CTE/UNION/nested SELECT) and dialect differences.
  Current filtering uses a safe derived-table wrapper; full AST rewriting is
  planned for future iterations.

* License

GPL-3.0-or-later. See [[file:LICENSE][LICENSE]].
